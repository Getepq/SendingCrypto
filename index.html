<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
<title>SendingCrypto Bot</title>
<link rel="icon" href="icon.png" />
<!-- Tailwind quick include -->
<script src="https://cdn.tailwindcss.com"></script>
<style>
  :root{
    --bg-1:#0f1624;
    --bg-2:#151a2a;
    --glass: rgba(23,28,46,0.72);
    --border: rgba(255,255,255,0.06);
    --muted: rgba(255,255,255,0.6);
    --accent: #3b82f6;
    --glow: rgba(59,130,246,0.14);
    --glow-strong: rgba(59,130,246,0.32);
  }
  html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;background:linear-gradient(180deg,var(--bg-1),var(--bg-2));color:#fff;-webkit-font-smoothing:antialiased}
  .glass{background:var(--glass);backdrop-filter: blur(14px) saturate(120%);border:1px solid var(--border);border-radius:14px;box-shadow:0 8px 30px rgba(0,0,0,0.4)}
  .container{max-width:420px;margin:0 auto;padding:16px 12px 110px}
  .profile{display:flex;gap:12px;align-items:center;padding:12px}
  .avatar{width:44px;height:44px;border-radius:12px;object-fit:cover;border:1px solid rgba(255,255,255,0.04)}
  .user-name{font-weight:600;font-size:15px}
  .user-sub{font-size:13px;color:var(--muted);margin-top:4px}

  .settings-btn{background:transparent;border:none;color:var(--muted);padding:8px;border-radius:8px;cursor:pointer}
  .balance-card{text-align:center;padding:28px 16px;border-radius:14px;margin-top:8px;position:relative}
  #balance-amount{font-size:32px;font-weight:700;cursor:pointer;display:inline-block;transition:all .25s ease}
  #balance-amount.pulse{filter:drop-shadow(0 12px 30px var(--glow));transform:scale(1.02)}
  .balance-sub{color:var(--muted);font-size:13px;margin-top:8px}

  .actions{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:12px}
  .action-btn{padding:12px;border-radius:12px;background:rgba(255,255,255,0.02);display:flex;flex-direction:column;align-items:center;gap:6px;transition:all .16s ease;color:var(--muted)}
  .action-btn:hover{background:rgba(255,255,255,0.04);color:#fff;box-shadow:0 10px 30px rgba(2,6,23,0.6);transform:translateY(-3px)}

  .assets-title{display:flex;justify-content:space-between;align-items:center;margin-top:14px;color:var(--muted);font-size:13px}
  .asset-card{padding:12px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.008));border:1px solid rgba(255,255,255,0.02);display:flex;justify-content:space-between;align-items:center;transition:all .14s ease}
  .asset-card:hover{transform:translateY(-3px);box-shadow:0 14px 40px rgba(2,6,23,0.6)}

  /* TON panel */
  #ton-panel{position:fixed;inset:0;display:none;align-items:flex-end;justify-content:center;z-index:60;background:rgba(0,0,0,0.5);backdrop-filter: blur(6px)}
  #ton-panel.active{display:flex}
  .panel-content{width:100%;max-width:520px;background:var(--glass);border-radius:22px 22px 0 0;padding:20px;box-shadow:0 -8px 40px rgba(0,0,0,0.6);border:1px solid var(--border);position:relative;animation:slideUp .36s ease}
  @keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}

  /* toast and success */
  #toast{position:fixed;top:14px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.6);padding:10px 14px;border-radius:10px;color:#fff;font-size:13px;opacity:0;transition:opacity .22s ease;z-index:220}
  #toast.show{opacity:1}
  #success-banner{position:fixed;top:18%;left:50%;transform:translateX(-50%) scale(.98);padding:10px 14px;border-radius:12px;background:linear-gradient(90deg,rgba(59,130,246,0.12),rgba(59,130,246,0.06));border:1px solid rgba(59,130,246,0.12);color:#fff;font-weight:700;box-shadow:0 10px 30px rgba(2,6,23,0.6);opacity:0;transition:all .28s ease;z-index:230;pointer-events:none}
  #success-banner.show{opacity:1;transform:translateX(-50%) scale(1)}

  /* bottom nav */
  .bottom-nav{position:fixed;left:12px;right:12px;bottom:12px;background:var(--glass);backdrop-filter: blur(12px);border-radius:14px;padding:10px 12px;border:1px solid rgba(255,255,255,0.03);display:flex;justify-content:space-around;z-index:200;box-shadow:0 12px 36px rgba(2,6,23,0.6)}
  .nav-btn{display:flex;flex-direction:column;align-items:center;gap:6px;color:var(--muted);font-size:12px}
  .nav-btn svg{transition:all .22s ease}
  .nav-btn.active{color:var(--accent)}
  .nav-btn.active svg{stroke:var(--accent);filter:drop-shadow(0 8px 26px var(--glow-strong))}

  .loading-spinner{border:3px solid rgba(255,255,255,0.08);border-top:3px solid var(--accent);border-radius:50%;width:28px;height:28px;animation:spin 1s linear infinite;margin:0 auto}
  @keyframes spin{from{transform:rotate(0)}to{transform:rotate(360deg)}}

  /* responsive */
  @media(max-width:460px){.container{padding:10px}.profile{padding:10px}.balance-card{padding:22px}}
</style>
</head>
<body>
  <div id="toast" aria-hidden="true"></div>
  <div id="success-banner" aria-hidden="true"></div>

  <main class="container" id="main-menu" style="display:none;">
    <div class="glass profile">
      <img id="user-photo" class="avatar" src="https://via.placeholder.com/80" alt="avatar">
      <div style="flex:1;min-width:0;">
        <div id="user-name" class="user-name">Загрузка...</div>
        <div id="wallet-short" class="user-sub" style="display:none;"></div>
      </div>
      <button id="settings-btn" class="settings-btn" aria-label="Настройки">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
      </button>
    </div>

    <div class="glass balance-card">
      <div>
        <div id="balance-amount">$0.00</div>
        <div class="balance-sub">Общий баланс</div>
      </div>
    </div>

    <div class="actions">
      <button class="action-btn" onclick="showToast('Отправка скоро будет доступна')">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
        <div class="action-label">Отправить</div>
      </button>
      <button class="action-btn" onclick="showToast('Получение скоро будет доступно')">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><polyline points="19 12 12 19 5 12"/></svg>
        <div class="action-label">Получить</div>
      </button>
      <button class="action-btn" onclick="showToast('Биржа скоро будет доступна')">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
        <div class="action-label">Биржа</div>
      </button>
      <button class="action-btn" onclick="showToast('Обмен скоро будет доступен')">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="17 1 21 5 17 9"/><path d="M3 11V9a4 4 0 0 1 4-4h14"/><polyline points="7 23 3 19 7 15"/><path d="M21 13v2a4 4 0 0 1-4 4H3"/></svg>
        <div class="action-label">Обмен</div>
      </button>
    </div>

    <div class="assets-title">
      <div style="font-weight:600">Активы</div>
      <button onclick="showToast('Скрыть мелкие балансы - скоро')" class="text-blue-400 text-xs">Скрыть мелкие балансы</button>
    </div>
    <div id="assets" style="margin-top:10px;display:flex;flex-direction:column;gap:10px;"></div>

  </main>

  <!-- TON Connect Panel -->
  <div id="ton-panel" aria-hidden="true">
    <div class="panel-content glass" role="dialog" aria-modal="true">
      <button id="close-ton" class="absolute top-4 right-4 text-white/60 active:text-white text-2xl leading-none" aria-label="Закрыть">&times;</button>
      <div style="display:flex;justify-content:center;margin-bottom:12px;">
        <div style="width:72px;height:72px;border-radius:999px;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,#2b6ef6,#3b82f6);box-shadow:0 12px 30px rgba(59,130,246,0.12);">
          <div style="width:40px;height:40px;border-radius:999px;background:#fff;"></div>
        </div>
      </div>
      <h2 class="text-xl font-bold mb-2 text-center">Подключите TON-кошелёк</h2>
      <p class="text-sm text-white/70 mb-6 text-center px-2 leading-relaxed">Подключив кошелёк, вы сможете использовать TON для переводов и покупок</p>
      <div id="ton-connect-button" class="flex justify-center mb-4 min-h-[56px]">
        <div class="loading-spinner" aria-hidden="true"></div>
      </div>
      <button id="manual-connect" class="w-full bg-gradient-to-r from-blue-500 to-blue-600 active:from-blue-600 active:to-blue-700 text-white font-semibold py-3.5 px-6 rounded-xl btn-glow mb-3 shadow-lg">Подключить кошелек</button>
      <button id="skip-ton" class="w-full text-white/70 active:text-white text-sm py-2">Пропустить</button>
    </div>
  </div>

  <!-- bottom navigation (fixed as requested) -->
  <nav class="bottom-nav" role="navigation">
    <button class="nav-btn active" data-tab="home">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
      <div>Главная</div>
    </button>
    <button class="nav-btn" data-tab="transfer">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
      <div>Переводы</div>
    </button>
    <button class="nav-btn" data-tab="history">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
      <div>История</div>
    </button>
    <button class="nav-btn" data-tab="profile">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
      <div>Профиль</div>
    </button>
  </nav>

  <!-- LOCAL TonConnect SDK (use your uploaded file, rename if needed) -->
  <script src="./tonconnect-ui.min.js"></script>

  <script>
    // ========== CONFIG ==========
    const MANIFEST_URL = '/tonconnect-manifest.json'; // vercel.json adds CORS header
    const TONCENTER_BALANCE_ENDPOINT = 'https://toncenter.com/api/v2/getAddressBalance';
    const BINANCE_24 = 'https://api.binance.com/api/v3/ticker/24hr?symbol=';
    const BINANCE_PRICE = 'https://api.binance.com/api/v3/ticker/price?symbol=';
    const CRYPTO_ASSETS = [
      { symbol: 'BTCUSDT', label: 'Bitcoin', short: 'BTC' },
      { symbol: 'ETHUSDT', label: 'Ethereum', short: 'ETH' },
      { symbol: 'TONUSDT', label: 'Toncoin', short: 'TON' },
      { symbol: 'SOLUSDT', label: 'Solana', short: 'SOL' },
      { symbol: 'LTCUSDT', label: 'Litecoin', short: 'LTC' }
    ];
    const CURRENCIES = ['USDT','TON','TRY','UAH','RUB']; // cycle order

    // ========== STATE ==========
    let tonConnectUI = null;
    let tonBalance = 0;
    let tonPrice = null;
    let fiatRates = { TRY:0, UAH:0, RUB:0 };
    let currencyIndex = 0;

    // ========== UI HELPERS ==========
    function showToast(text){
      const t = document.getElementById('toast');
      t.textContent = text;
      t.classList.add('show');
      clearTimeout(t._t);
      t._t = setTimeout(()=> t.classList.remove('show'), 2800);
    }
    function showSuccess(text){
      const s = document.getElementById('success-banner');
      s.textContent = text;
      s.classList.add('show');
      clearTimeout(s._t);
      s._t = setTimeout(()=> s.classList.remove('show'), 2200);
    }

    // ========== BINANCE / TONCENTER ==========
    async function fetchBinance24(symbol){
      try{
        const r = await fetch(BINANCE_24 + encodeURIComponent(symbol));
        if(!r.ok) throw new Error('binance 24 failed');
        return await r.json();
      }catch(e){
        console.warn('binance24 failed', symbol, e);
        return null;
      }
    }
    async function fetchBinancePrice(symbol){
      try{
        const r = await fetch(BINANCE_PRICE + encodeURIComponent(symbol));
        if(!r.ok) throw new Error('binance price failed');
        const j = await r.json();
        return j && j.price ? Number(j.price) : null;
      }catch(e){
        console.warn('binance price failed', symbol, e);
        return null;
      }
    }
    async function fetchTonBalance(addr){
      try{
        const r = await fetch(`${TONCENTER_BALANCE_ENDPOINT}?address=${encodeURIComponent(addr)}`);
        const j = await r.json();
        if(j && j.ok && j.result !== undefined) return Number(j.result) / 1e9;
        return 0;
      }catch(e){
        console.error('toncenter error', e);
        return 0;
      }
    }

    // ========== RENDER ASSETS ==========
    async function loadAssets(){
      const container = document.getElementById('assets');
      container.innerHTML = '';
      try{
        const promises = CRYPTO_ASSETS.map(async a => {
          const d = await fetchBinance24(a.symbol);
          return {
            ...a,
            price: d && d.lastPrice ? Number(d.lastPrice) : 0,
            change: d && d.priceChangePercent ? Number(d.priceChangePercent) : 0
          };
        });
        const res = await Promise.all(promises);
        container.innerHTML = res.map(renderAssetHtml).join('');
      }catch(e){
        console.error('loadAssets error', e);
      }
    }
    function renderAssetHtml(a){
      const changeColor = a.change >= 0 ? 'text-green-400' : 'text-red-400';
      const arrow = a.change >= 0 ? '▲' : '▼';
      const priceStr = a.price ? a.price.toLocaleString('en-US', { minimumFractionDigits:2, maximumFractionDigits:8 }) : '0.00';
      return `
        <div class="asset-card glass">
          <div>
            <div style="font-weight:600">${a.label}</div>
            <div style="font-size:13px;color:var(--muted)">$${priceStr} <span class="${changeColor} ml-2">${arrow} ${Math.abs(a.change).toFixed(2)}%</span></div>
          </div>
          <div style="text-align:right">
            <div style="font-weight:600">0 ${a.short}</div>
            <div style="font-size:12px;color:var(--muted)">$0.00</div>
          </div>
        </div>
      `;
    }

    // ========== BALANCE UI ==========
    async function updateTonAndFiat(){
      const p = await fetchBinancePrice('TONUSDT');
      if(p) tonPrice = p;
      const tryP = await fetchBinancePrice('USDTTRY');
      const uahP = await fetchBinancePrice('USDTUAH');
      const rubP = await fetchBinancePrice('USDTRUB') || await fetchBinancePrice('USDTTRUB') || null;
      fiatRates.TRY = tryP ? Number(tryP) : fiatRates.TRY || 0;
      fiatRates.UAH = uahP ? Number(uahP) : fiatRates.UAH || 0;
      fiatRates.RUB = rubP ? Number(rubP) : fiatRates.RUB || 0;
    }
    function updateBalanceUI(){
      const cur = CURRENCIES[currencyIndex];
      const el = document.getElementById('balance-amount');
      if(cur === 'TON'){
        el.textContent = `${Number(tonBalance).toFixed(4)} TON`;
      } else if(cur === 'USDT'){
        const usd = (tonPrice !== null) ? (tonBalance * tonPrice) : 0;
        el.textContent = `$${usd.toFixed(2)}`;
      } else {
        const usd = (tonPrice !== null) ? (tonBalance * tonPrice) : 0;
        const rate = fiatRates[cur] || 0;
        el.textContent = rate ? `${(usd * rate).toFixed(2)} ${cur}` : 'Загрузка...';
      }
      el.classList.add('pulse');
      setTimeout(()=> el.classList.remove('pulse'), 900);
    }

    document.addEventListener('click', e => {
      if(e.target && e.target.id === 'balance-amount') {
        currencyIndex = (currencyIndex + 1) % CURRENCIES.length;
        updateBalanceUI();
      }
    });

    // ========== TonConnect initialization with robust checks ==========
    async function initTonConnect(){
      // wait for TonConnectUI to be present (local file might take time)
      let attempts = 0;
      while(!window.TonConnectUI && attempts < 50){
        await new Promise(r => setTimeout(r, 100));
        attempts++;
      }
      if(!window.TonConnectUI){
        console.error('TonConnect UI not loaded (window.TonConnectUI is undefined).');
        showToast('Ошибка SDK: не удалось загрузить TonConnect UI');
        // leave panel visible so user can try manual connect
        document.getElementById('ton-connect-button').innerHTML = '<div style="color:#ff6b6b">Ошибка загрузки SDK</div>';
        return;
      }

      try {
        tonConnectUI = new TonConnectUI({
          manifestUrl: MANIFEST_URL,
          buttonRootId: 'ton-connect-button'
        });
      } catch(e){
        console.error('Ошибка инициализации TonConnectUI:', e);
        showToast('Ошибка SDK: ' + (e && e.message ? e.message : e));
        document.getElementById('ton-connect-button').innerHTML = '<div style="color:#ff6b6b">Ошибка SDK</div>';
        return;
      }

      // attach manual connect
      document.getElementById('manual-connect').onclick = async () => {
        try {
          // give visual transition: hide panel slightly, open modal
          const panel = document.getElementById('ton-panel');
          panel.classList.remove('active');
          panel.style.pointerEvents = 'none';
          // small delay to let animation play
          await new Promise(r => setTimeout(r, 300));
          await tonConnectUI.openModal();
        } catch(err){
          console.error('tonConnect openModal error', err);
          showToast('Ошибка при открытии SDK: ' + (err && err.message ? err.message : err));
          // restore panel so user can try again
          const p = document.getElementById('ton-panel');
          p.style.pointerEvents = 'auto';
          p.style.display = 'flex';
          requestAnimationFrame(() => p.classList.add('active'));
        }
      };

      // status change listener
      tonConnectUI.onStatusChange(async wallet => {
        if(wallet){
          try {
            const addr = wallet.account.address;
            localStorage.setItem('ton_wallet', addr);
            const short = addr.slice(0,6) + '...' + addr.slice(-4);
            document.getElementById('wallet-short').textContent = short;
            document.getElementById('wallet-short').style.display = 'block';
            // fetch balance
            tonBalance = await fetchTonBalance(addr);
            await updateTonAndFiat();
            updateBalanceUI();
            showSuccess('Кошелек успешно подключён');
            // close panel nicely
            const panel = document.getElementById('ton-panel');
            panel.classList.remove('active');
            setTimeout(()=> { panel.style.display = 'none'; panel.style.pointerEvents = 'auto'; }, 360);
          } catch(e){
            console.error('onStatusChange error', e);
            showToast('Ошибка чтения кошелька: ' + (e.message || e));
          }
        } else {
          // disconnected
          localStorage.removeItem('ton_wallet');
          showToast('Кошелек отключён');
        }
      });

      // If SDK created a default button (it will mount under ton-connect-button), it's OK.
      // Also add additional debug in case manifest not found or invalid:
      try {
        // verify manifest fetch (extra check)
        const mres = await fetch(MANIFEST_URL, { method: 'GET' });
        if(!mres.ok) console.warn('Warning: manifest fetch returned ' + mres.status);
      } catch(e){
        console.warn('manifest fetch failed', e);
      }
    }

    // ========== panel open/close helpers ==========
    function openTonPanel(){
      const p = document.getElementById('ton-panel');
      p.style.display = 'flex';
      requestAnimationFrame(()=> p.classList.add('active'));
    }
    function closeTonPanel(){
      const p = document.getElementById('ton-panel');
      p.classList.remove('active');
      setTimeout(()=> p.style.display = 'none', 320);
    }

    // ========== bottom nav behavior ==========
    document.querySelectorAll('.nav-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        showToast(btn.innerText.trim());
      });
    });

    // ========== settings button ==========
    document.getElementById('settings-btn').addEventListener('click', () => {
      showToast('Настройки скоро будут доступны');
    });

    // ========== APP START ==========
    window.addEventListener('DOMContentLoaded', async () => {
      // Telegram WebApp init if present
      const tg = window.Telegram?.WebApp;
      if(tg){
        try { tg.ready(); tg.expand(); tg.setBackgroundColor('#0f1624'); } catch(e){}
      }

      // load user info if available
      if(tg?.initDataUnsafe?.user){
        const u = tg.initDataUnsafe.user;
        document.getElementById('user-name').textContent = (u.first_name || '') + (u.last_name ? ' ' + u.last_name : '');
        if(u.photo_url) document.getElementById('user-photo').src = u.photo_url;
      } else {
        document.getElementById('user-name').textContent = 'Demo User';
      }

      // show main menu hidden initially to avoid FOUC
      document.getElementById('main-menu').style.display = 'block';

      // load asset prices and init TonConnect
      await loadAssets();
      await updateTonAndFiat();
      await initTonConnect();

      // if wallet already saved, restore
      const saved = localStorage.getItem('ton_wallet');
      if(saved){
        document.getElementById('wallet-short').textContent = saved.slice(0,6) + '...' + saved.slice(-4);
        document.getElementById('wallet-short').style.display = 'block';
        // fetch current balance
        tonBalance = await fetchTonBalance(saved);
        await updateTonAndFiat();
        updateBalanceUI();
        // hide panel if visible
        const p = document.getElementById('ton-panel'); if(p){ p.style.display='none'; p.classList.remove('active'); }
      } else {
        // open panel if no wallet
        openTonPanel();
      }

      // attach panel close handlers
      document.getElementById('skip-ton').onclick = closeTonPanel;
      document.getElementById('close-ton').onclick = closeTonPanel;
      document.getElementById('ton-panel').onclick = (e) => { if(e.target.id === 'ton-panel') closeTonPanel(); };

      // periodic updates (prices & balance)
      setInterval(async () => {
        await loadAssets();
        await updateTonAndFiat();
        updateBalanceUI();
      }, 60_000);
      setInterval(async () => {
        const w = localStorage.getItem('ton_wallet');
        if(w){
          tonBalance = await fetchTonBalance(w);
          updateBalanceUI();
        }
      }, 30_000);
    });
  </script>
</body>
</html>
