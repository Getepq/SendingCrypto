<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SendingCrypto MiniApp</title>
  <script src="./tonconnect-ui.min.js"></script>
  <style>
    :root {
      --bg:#0f1724;--card:#111827;--muted:#9aa3b2;--accent:#60a5fa;
      font-family:Inter,system-ui;
    }
    html,body{height:100%;margin:0;background:#071425;color:#e6eef8}
    .app{max-width:420px;margin:0 auto;padding:18px 12px 80px;}
    .topbar{display:flex;align-items:center;gap:12px;padding:8px 6px}
    .close{color:var(--muted);font-size:14px;cursor:pointer}
    .profile{display:flex;align-items:center;gap:12px;flex:1;}
    .avatar{width:52px;height:52px;border-radius:12px;background:#0f2a3d;
      display:flex;align-items:center;justify-content:center;font-weight:600;}
    .user-info{display:flex;flex-direction:column;}
    .user-name{font-weight:700}
    .user-sub{font-size:12px;color:var(--muted);word-break:break-all;}
    .balance-card{background:var(--card);border-radius:12px;padding:22px;text-align:center;margin-top:10px;}
    .balance-card .amount{font-size:34px;font-weight:700}
    .balance-card .small{color:var(--muted);font-size:13px;margin-top:6px;cursor:pointer}
    .actions{display:flex;gap:10px;margin-top:14px}
    .action-btn{flex:1;background:#0b1220;padding:12px;border-radius:12px;text-align:center;cursor:pointer}
    .assets{margin-top:18px}
    .asset{background:#0b1220;border-radius:10px;padding:12px;display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;}
    .coin-icon{width:44px;height:44;border-radius:8px;background:#08202e;display:flex;align-items:center;justify-content:center;font-weight:700}
    .wallet-modal{position:fixed;left:0;right:0;bottom:0;height:50vh;background:#0b1220;
      border-top-left-radius:14px;border-top-right-radius:14px;padding:18px;display:none;}
    .wallet-modal.show{display:block}
    .wallet-actions{display:flex;gap:10px;margin-top:16px}
    .btn-primary{flex:1;padding:12px;border-radius:10px;background:linear-gradient(90deg,#0ea5e9,#3b82f6);border:none;color:#fff;font-weight:700;cursor:pointer}
    .btn-ghost{flex:1;padding:12px;border-radius:10px;background:transparent;border:1px solid rgba(255,255,255,0.1);color:var(--muted);cursor:pointer}
  </style>
</head>
<body>
  <div class="app">
    <div class="topbar">
      <div class="close" id="btn-close">Закрыть</div>
      <div class="profile">
        <div class="avatar" id="avatar">U</div>
        <div class="user-info">
          <div class="user-name" id="user-name">Пользователь</div>
          <div class="user-sub" id="user-sub">@user</div>
          <div class="user-sub" id="ton-address" style="color:#60a5fa;font-size:11px;margin-top:3px;display:none;"></div>
        </div>
      </div>
    </div>

    <div class="balance-card">
      <div class="amount" id="total-balance">$0.00</div>
      <div class="small" id="balance-currency">Общий баланс · USD ▾</div>
    </div>

    <div class="actions">
      <div class="action-btn">Отправить</div>
      <div class="action-btn">Получить</div>
      <div class="action-btn">Биржа</div>
      <div class="action-btn">Обмен</div>
    </div>

    <div class="assets" id="assets"></div>
  </div>

  <!-- Плашка подключения TON -->
  <div class="wallet-modal" id="wallet-modal">
    <div style="width:48px;height:48px;border-radius:10px;background:linear-gradient(135deg,#0ea5e9,#6366f1);
      display:flex;align-items:center;justify-content:center;font-weight:800;color:#fff">TON</div>
    <div style="margin-top:14px;font-weight:800;font-size:18px">Подключить TON кошелёк</div>
    <div style="color:#9aa3b2;margin-top:6px">Подключите кошелёк TON, чтобы отправлять и получать Toncoin прямо из приложения.</div>
    <div class="wallet-actions">
      <button class="btn-primary" id="connect-ton">Подключить</button>
      <button class="btn-ghost" id="skip-ton">Пропустить</button>
    </div>
    <div id="ton-connect-ui" style="margin-top:16px"></div>
  </div>

  <script>
  const tg = window.Telegram?.WebApp;
  if(tg) tg.ready();

  // --- User Info ---
  const user = tg?.initDataUnsafe?.user || {first_name:"Test",username:"test_user"};
  document.getElementById("user-name").textContent = user.first_name || "Пользователь";
  document.getElementById("user-sub").textContent = user.username ? '@'+user.username : "mini-app";
  document.getElementById("avatar").textContent = (user.first_name||"U")[0];

  // --- TON Connect Init ---
  const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
    manifestUrl: 'https://sending-crypto.vercel.app/tonconnect-manifest.json',
    buttonRootId: 'ton-connect-ui'
  });

  const walletModal = document.getElementById("wallet-modal");
  const connectBtn = document.getElementById("connect-ton");
  const skipBtn = document.getElementById("skip-ton");
  const tonAddrEl = document.getElementById("ton-address");

  // Проверка: есть ли сохранённый кошелёк
  let savedWallet = localStorage.getItem("tonAddress");

  if (!savedWallet) {
    walletModal.classList.add("show");
  } else {
    tonAddrEl.style.display = "block";
    tonAddrEl.textContent = formatTonAddress(savedWallet);
  }

  // При нажатии "Подключить"
  connectBtn.addEventListener("click", async () => {
    try {
      await tonConnectUI.connectWallet();
    } catch (e) {
      console.error(e);
    }
  });

  // Когда кошелёк подключён
  tonConnectUI.onStatusChange(wallet => {
    if (wallet && wallet.account) {
      const addr = wallet.account.address;
      localStorage.setItem("tonAddress", addr);
      tonAddrEl.style.display = "block";
      tonAddrEl.textContent = formatTonAddress(addr);
      walletModal.classList.remove("show");
      console.log("TON подключен:", addr);
    }
  });

  // "Пропустить"
  skipBtn.addEventListener("click", () => {
    walletModal.classList.remove("show");
  });

  // Кнопка "Закрыть"
  document.getElementById("btn-close").addEventListener("click", () => {
    tg?.close();
  });

  // Форматирование адреса TON (короткий вид)
  function formatTonAddress(addr) {
    return addr.slice(0, 6) + "..." + addr.slice(-6);
  }
  </script>
</body>
</html>
