<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>SendingCrypto — Mini WebApp</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#05060a;
    --card:#0b1116;
    --muted:#8f99a6;
    --accent:#7c5cff;
    --accent-2:#3ddbd9;
    --glass: rgba(255,255,255,0.02);
    --glass-2: rgba(255,255,255,0.03);
    --radius:14px;
  }
  *{box-sizing:border-box}
  html,body,#root{height:100%}
  body{
    margin:0;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;
    background:linear-gradient(180deg,#041018 0%, #061228 100%);
    color:#e6eef6; -webkit-font-smoothing:antialiased;
    display:flex;align-items:center;justify-content:center;padding:12px;
  }

  /* App shell sized to container; inside is scrollable content to work well in Telegram iframe */
  .app {
    width:420px; max-width:100%; height:800px; max-height:calc(100vh - 24px);
    border-radius:14px; background:linear-gradient(180deg, rgba(255,255,255,0.015), rgba(255,255,255,0.008));
    box-shadow: 0 14px 40px rgba(2,6,23,0.6); border:1px solid rgba(255,255,255,0.03);
    display:flex;flex-direction:column; overflow:hidden;
  }

  /* internal scroll area */
  .pane { padding:14px; overflow:auto; flex:1; }
  @media (max-width:440px){ .app{ height:100vh; border-radius:0; } .pane{ padding:12px;} }

  .top {
    display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:10px;
  }
  .profile { display:flex; align-items:center; gap:12px; min-width:0; }
  .avatar {
    width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent-2));
    display:flex;align-items:center;justify-content:center;font-weight:700;color:white;font-size:16px;flex-shrink:0; overflow:hidden;
  }
  .avatar img{ width:100%; height:100%; object-fit:cover; display:block; }
  .user { min-width:0; }
  .user .name { font-weight:700; font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .user .nick { font-size:12px; color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

  .lang {
    display:flex; align-items:center; gap:8px; padding:6px; border-radius:999px; background:var(--glass);
    font-size:12px; color:var(--muted); cursor:pointer; user-select:none;
  }
  .lang .dot { padding:4px 8px; background:rgba(255,255,255,0.012); border-radius:999px; font-weight:700; color:var(--accent); }

  /* balance card */
  .balance-card {
    display:flex; justify-content:space-between; gap:12px; align-items:center;
    background:linear-gradient(180deg,rgba(255,255,255,0.01),rgba(255,255,255,0.008)); padding:12px; border-radius:12px;
    border:1px solid rgba(255,255,255,0.02);
  }
  .balance-left { display:flex; flex-direction:column; gap:6px; min-width:0; }
  .balance-left .title { font-size:12px; color:var(--muted); }
  .balance-left .amount { font-weight:800; font-size:26px; display:flex; align-items:baseline; gap:8px; cursor:pointer; }
  .balance-left .amount small { color:var(--muted); font-size:13px; font-weight:600; }

  .balance-actions { display:flex; flex-direction:column; gap:8px; min-width:140px; }
  .row { display:flex; gap:8px; }
  .btn {
    flex:1; padding:8px 10px; border-radius:10px; background:var(--glass); color:inherit; text-align:center; font-weight:700; font-size:13px;
    border:1px solid rgba(255,255,255,0.02); cursor:pointer;
  }
  .btn.primary { background:linear-gradient(90deg,var(--accent),var(--accent-2)); color:#061018; border:none; box-shadow:0 8px 20px rgba(124,92,255,0.12); }

  /* QR card separate */
  .qr {
    margin-top:12px; padding:12px; border-radius:12px; display:flex; align-items:center; justify-content:space-between;
    background:linear-gradient(180deg, rgba(255,255,255,0.008), rgba(255,255,255,0.006)); border:1px solid rgba(255,255,255,0.02);
    cursor:pointer;
  }
  .qr .left { display:flex; align-items:center; gap:12px; min-width:0; }
  .qr img { width:40px; height:40px; border-radius:8px; }
  .qr .t { font-weight:700; font-size:14px; }
  .qr .s { color:var(--muted); font-size:12px; }

  /* list */
  .list { margin-top:12px; display:flex; flex-direction:column; gap:8px; }
  .item {
    display:flex; align-items:center; justify-content:space-between; gap:12px;
    padding:10px; border-radius:10px; background:var(--glass); border:1px solid rgba(255,255,255,0.02);
  }
  .item-left { display:flex; align-items:center; gap:10px; min-width:0; }
  .coin-icon { width:36px; height:36px; border-radius:8px; background:rgba(255,255,255,0.02); display:flex; align-items:center; justify-content:center; overflow:hidden; flex-shrink:0; }
  .coin-icon img{ width:100%; height:100%; object-fit:contain; display:block; }
  .coin-meta { display:flex; flex-direction:column; min-width:0; }
  .coin-name { font-weight:700; font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .coin-sub { font-size:12px; color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

  .item-right { text-align:right; min-width:120px; }
  .price { font-weight:800; font-size:14px; }
  .value { font-size:12px; color:var(--muted); margin-top:4px; }

  /* small footer */
  .footer { text-align:center; font-size:12px; color:var(--muted); padding:8px 0; }

  /* skeleton / loading */
  .skeleton { background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.03), rgba(255,255,255,0.02)); border-radius:6px; }
  .skeleton.h-12{ height:12px; width:100%; }
  .skeleton.h-18{ height:18px; width:120px; }

</style>
</head>
<body>
  <div class="app" id="root">
    <div class="pane" id="pane">
      <div class="top">
        <div class="profile">
          <div class="avatar" id="avatar"><!-- injected --></div>
          <div class="user">
            <div class="name" id="uname">Guest</div>
            <div class="nick" id="unick">@guest</div>
          </div>
        </div>

        <div class="lang" id="langToggle" title="Switch language">
          <div style="font-size:12px;color:var(--muted)"><span id="langLabel">RU</span></div>
          <div class="dot" id="langDot">EN</div>
        </div>
      </div>

      <div class="balance-card" role="region" aria-label="balance">
        <div class="balance-left">
          <div class="title" id="balanceTitle">Total balance</div>
          <div class="amount" id="balanceAmount" title="Click to change display currency">
            <div id="balanceSum">0.000000</div>
            <small id="balanceCur">$</small>
          </div>
        </div>

        <div class="balance-actions">
          <div class="row">
            <div class="btn" id="btnRefill">Refill</div>
            <div class="btn" id="btnWithdraw">Withdraw</div>
          </div>
          <div class="row">
            <div class="btn" id="btnSwap">Swap</div>
            <div class="btn" id="btnMarket">Market</div>
          </div>
        </div>
      </div>

      <div class="qr" id="qrCard" title="Pay by QR">
        <div class="left">
          <img src="https://upload.wikimedia.org/wikipedia/commons/8/80/QRCode_Example.svg" alt="QR">
          <div>
            <div class="t" id="qrTitle">Pay by QR</div>
            <div class="s" id="qrSub">Pay for purchases using crypto</div>
          </div>
        </div>
        <div style="color:var(--muted); font-weight:700">→</div>
      </div>

      <div class="list" id="coinList">
        <!-- coins injected here -->
        <div class="item skeleton" style="height:64px"></div>
        <div class="item skeleton" style="height:64px"></div>
        <div class="item skeleton" style="height:64px"></div>
      </div>

      <div class="footer" id="footerNote">Loading prices...</div>
    </div>
  </div>

<script>
/* Robust single-file WebApp
   - Telegram WebApp SDK usage (if available)
   - CoinGecko for live prices
   - Clean responsive layout, safe fallbacks
*/

/* ---------- Config ---------- */
const COINS = [
  { id: "toncoin", symbol: "TON", name: "Toncoin" },
  { id: "tether", symbol: "USDT", name: "Tether" },
  { id: "solana", symbol: "SOL", name: "Solana" },
  { id: "bitcoin", symbol: "BTC", name: "Bitcoin" },
  { id: "litecoin", symbol: "LTC", name: "Litecoin" },
  { id: "ethereum", symbol: "ETH", name: "Ethereum" }
];

// Holdings in each coin (demo). Display will show price * amount in selected fiat.
const HOLDINGS = {
  toncoin: 5.25,
  tether: 100,
  solana: 0.5,
  bitcoin: 0.02,
  litecoin: 1.5,
  ethereum: 0.12
};

// Fiats to cycle through on balance click
const FIATS = [
  { code: "usd", symbol: "$", label_en: "USD", label_ru: "USDT" },
  { code: "rub", symbol: "₽", label_en: "RUB", label_ru: "Рубли" },
  { code: "eur", symbol: "€", label_en: "EUR", label_ru: "EUR" },
  { code: "uah", symbol: "₴", label_en: "UAH", label_ru: "Гривны" },
  { code: "try", symbol: "₺", label_en: "TRY", label_ru: "Лиры" }
];

const COINGECKO = "https://api.coingecko.com/api/v3";

/* ---------- State ---------- */
let LANG = "en"; // default: en; toggles to 'ru'
let fiatIndex = 0;
let latest = {}; // coin -> { usd, rub, eur, uah, try, usd_24h_change, image }
let tg = (window.Telegram && window.Telegram.WebApp) ? window.Telegram.WebApp : null;

/* ---------- Elements ---------- */
const avatarEl = document.getElementById("avatar");
const unameEl = document.getElementById("uname");
const unickEl = document.getElementById("unick");
const langToggle = document.getElementById("langToggle");
const langLabel = document.getElementById("langLabel");
const langDot = document.getElementById("langDot");
const balanceTitle = document.getElementById("balanceTitle");
const balanceSum = document.getElementById("balanceSum");
const balanceCur = document.getElementById("balanceCur");
const coinList = document.getElementById("coinList");
const footerNote = document.getElementById("footerNote");
const qrCard = document.getElementById("qrCard");

/* ---------- I18N ---------- */
const STR = {
  en: {
    total: "Total balance",
    refill: "Refill",
    withdraw: "Withdraw",
    swap: "Swap",
    market: "Market",
    qrTitle: "Pay by QR",
    qrSub: "Pay for purchases using crypto",
    loading: "Loading prices...",
    exchangeError: "Failed to load prices"
  },
  ru: {
    total: "Общий баланс",
    refill: "Пополнить",
    withdraw: "Вывести",
    swap: "Обмен",
    market: "Биржа",
    qrTitle: "Оплата по QR-коду",
    qrSub: "Оплачивайте покупки с помощью криптовалюты",
    loading: "Загрузка курсов...",
    exchangeError: "Ошибка загрузки курсов"
  }
};

/* ---------- Helpers ---------- */
function setLangUI() {
  langLabel.textContent = LANG === "ru" ? "RU" : "EN";
  langDot.textContent = LANG === "ru" ? "EN" : "RU";
  balanceTitle.textContent = STR[LANG].total;
  document.getElementById("btnRefill").textContent = STR[LANG].refill;
  document.getElementById("btnWithdraw").textContent = STR[LANG].withdraw;
  document.getElementById("btnSwap").textContent = STR[LANG].swap;
  document.getElementById("btnMarket").textContent = STR[LANG].market;
  document.getElementById("qrTitle").textContent = STR[LANG].qrTitle;
  document.getElementById("qrSub").textContent = STR[LANG].qrSub;
  footerNote.textContent = STR[LANG].loading;
}

function formatNumber(v, locale) {
  if (v === null || v === undefined || isNaN(v)) return "—";
  const abs = Math.abs(v);
  const digits = abs < 1 ? 6 : (abs < 1000 ? 4 : 2);
  return new Intl.NumberFormat(locale, { minimumFractionDigits: digits, maximumFractionDigits: digits }).format(v);
}

function formatCurrency(amount, fiatCode) {
  const locale = LANG === "ru" ? "ru-RU" : "en-US";
  const digits = Math.abs(amount) < 1 ? 6 : 2;
  return new Intl.NumberFormat(locale, { minimumFractionDigits: digits, maximumFractionDigits: digits }).format(amount);
}

/* ---------- Telegram init (safe) ---------- */
function initTelegram() {
  if (!tg) {
    // Not inside Telegram - mock a user for local testing
    unameEl.textContent = "Yipir";
    unickEl.textContent = "@yipir";
    avatarEl.innerHTML = `<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:16px;color:#061018;background:linear-gradient(135deg,var(--accent),var(--accent-2));">Y</div>`;
    return;
  }
  try {
    // expand if available
    tg.expand && tg.expand();
    const user = tg.initDataUnsafe?.user || tg.initData?.user || null;
    if (user) {
      const name = (user.first_name || "") + (user.last_name ? " " + user.last_name : "");
      unameEl.textContent = name || (user.username || "User");
      unickEl.textContent = user.username ? ("@" + user.username) : ("id:" + (user.id || ""));
      // Telegram SDK doesn't expose avatar URL; generate initials
      const initials = ((user.first_name || "").charAt(0) + (user.last_name || "").charAt(0)).toUpperCase() || (user.username || "U").substr(0,2).toUpperCase();
      avatarEl.innerHTML = `<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:16px;color:#061018;background:linear-gradient(135deg,var(--accent),var(--accent-2));">${initials}</div>`;
    } else {
      // fallback
      unameEl.textContent = "User";
      unickEl.textContent = "@user";
      avatarEl.textContent = "U";
    }
  } catch (e) {
    console.warn("Telegram init error", e);
    unameEl.textContent = "User";
    unickEl.textContent = "@user";
  }
}

/* ---------- Data fetching ---------- */
async function fetchPrices() {
  try {
    footerNote.textContent = STR[LANG].loading;
    // ids query
    const ids = COINS.map(c => c.id).join(",");
    const vs = ["usd","rub","eur","uah","try"].join(",");
    const url = `${COINGECKO}/simple/price?ids=${encodeURIComponent(ids)}&vs_currencies=${vs}&include_24hr_change=true`;
    const r = await fetch(url, { cache: "no-cache" });
    if (!r.ok) throw new Error("coingecko:" + r.status);
    const data = await r.json();
    // fetch images (one request per coin is limited but acceptable for this small list)
    const imagePromises = COINS.map(async (c) => {
      try {
        const rr = await fetch(`${COINGECKO}/coins/${encodeURIComponent(c.id)}?localization=false&tickers=false&market_data=false&community_data=false&developer_data=false&sparkline=false`);
        if (!rr.ok) return null;
        const dd = await rr.json();
        return dd.image?.small || dd.image?.thumb || dd.image?.large || null;
      } catch (e) { return null; }
    });
    const images = await Promise.all(imagePromises);

    COINS.forEach((c, idx) => {
      latest[c.id] = {
        ...data[c.id],
        image: images[idx] || null
      };
    });
    footerNote.textContent = ""; // clear
    renderList();
    updateBalance();
  } catch (err) {
    console.error("fetchPrices error", err);
    footerNote.textContent = STR[LANG].exchangeError;
  }
}

/* ---------- UI render ---------- */
function renderList() {
  coinList.innerHTML = "";
  const locale = LANG === "ru" ? "ru-RU" : "en-US";

  COINS.forEach(c => {
    const d = latest[c.id] || {};
    const price = d.usd || 0;
    const change = d.usd_24h_change !== undefined ? d.usd_24h_change : null;
    const img = d.image || '';
    const amount = HOLDINGS[c.id] || 0;
    const valueUSD = amount * (d.usd || 0);
    // compute display price in selected fiat
    const fiat = FIATS[fiatIndex];
    const priceInFiat = (d[fiat.code] !== undefined) ? d[fiat.code] : (price * 1); // fallback
    const valueInFiat = amount * priceInFiat;

    const item = document.createElement("div");
    item.className = "item";
    item.innerHTML = `
      <div class="item-left">
        <div class="coin-icon">${img ? `<img src="${img}" alt="${c.name}">` : c.symbol}</div>
        <div class="coin-meta">
          <div class="coin-name">${c.name} <span style="font-weight:600;color:var(--muted);font-size:12px"> ${c.symbol}</span></div>
          <div class="coin-sub">ID: ${c.id}</div>
        </div>
      </div>
      <div class="item-right">
        <div class="price">${FIATS[fiatIndex].symbol} ${formatCurrency(priceInFiat, fiat.code)}</div>
        <div class="value">${formatNumber(amount, locale)} • ${FIATS[fiatIndex].symbol} ${formatCurrency(valueInFiat, fiat.code)}</div>
      </div>
    `;
    coinList.appendChild(item);
  });
}

/* ---------- Balance calculation ---------- */
async function updateBalance() {
  // compute total in selected fiat
  const fiat = FIATS[fiatIndex];
  let total = 0;
  COINS.forEach(c => {
    const d = latest[c.id] || {};
    const price = (d[fiat.code] !== undefined) ? d[fiat.code] : (d.usd || 0);
    const amount = HOLDINGS[c.id] || 0;
    total += (price * amount);
  });
  balanceSum.textContent = formatCurrency(total, fiat.code);
  balanceCur.textContent = fiat.symbol;
}

/* ---------- Events ---------- */
document.getElementById("balanceAmount").addEventListener("click", async () => {
  fiatIndex = (fiatIndex + 1) % FIATS.length;
  await updateBalance();
  renderList();
});

langToggle.addEventListener("click", () => {
  LANG = LANG === "ru" ? "en" : "ru";
  setLangUI();
  renderList();
  updateBalance();
});

document.getElementById("btnRefill").addEventListener("click", () => { alert(LANG === "ru" ? "Функция Пополнить (демо)" : "Refill (demo)"); });
document.getElementById("btnWithdraw").addEventListener("click", () => { alert(LANG === "ru" ? "Функция Вывести (демо)" : "Withdraw (demo)"); });
document.getElementById("btnSwap").addEventListener("click", () => { alert(LANG === "ru" ? "Функция Обмен (демо)" : "Swap (demo)"); });
document.getElementById("btnMarket").addEventListener("click", () => { alert(LANG === "ru" ? "Биржа (демо)" : "Market (demo)"); });

qrCard.addEventListener("click", () => {
  // placeholder: in production you'd open QR modal or create qr image
  alert(LANG === "ru" ? "Открыть оплату по QR (демо)" : "Open QR payment (demo)");
});

/* ---------- Init ---------- */
async function init() {
  initTelegram();
  setLangUI();
  // initial skeleton shown; then fetch
  await fetchPrices();
  // refresh every 45s but don't pile up if user navigates
  setInterval(fetchPrices, 45000);
}

// start
init();

</script>
</body>
</html>
