<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>SendingCrypto</title>

  <!-- TonConnect UI (локальный файл на Vercel: /tonconnect-ui.min.js) -->
  <script src="./tonconnect-ui.min.js"></script>

  <style>
    /* --- Стили, старался полностью повторить визуал --- */
    :root{
      --bg:#071225;
      --card:#0e1a29;
      --muted:#9aa3b2;
      --accent:#60a5fa;
      --danger:#ef4444;
      --green:#10b981;
      --glass: rgba(255,255,255,0.02);
      font-family: Inter, "Helvetica Neue", Arial, sans-serif;
    }
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#071225,#04141f);color:#e6eef8;-webkit-font-smoothing:antialiased}
    .wrap{max-width:420px;margin:0 auto;padding:14px 12px 100px;box-sizing:border-box}

    /* Top profile */
    .top-row{display:flex;align-items:center;gap:10px}
    .close{color:var(--muted);font-size:15px;cursor:pointer}
    .profile-card{flex:1;background:linear-gradient(180deg,#0b2233,#081726);border-radius:12px;padding:10px 12px;display:flex;align-items:center;gap:12px}
    .avatar{width:48px;height:48;border-radius:999px;background:#0f2a3d;display:flex;align-items:center;justify-content:center;font-weight:700;color:#dbeafe;overflow:hidden}
    .profile-name{display:flex;flex-direction:column}
    .name{font-weight:700}
    .sub{font-size:13px;color:var(--muted);margin-top:2px;word-break:break-all}
    .menu-dot{width:36px;height:36;background:#0b2333;border-radius:8px;display:flex;align-items:center;justify-content:center;color:var(--muted);font-weight:700}

    /* Balance card */
    .balance{background:linear-gradient(180deg,#0d2130,#0a1b2a);border-radius:14px;padding:22px;margin-top:12px;text-align:center;box-shadow:0 6px 18px rgba(2,6,12,0.6);border:1px solid rgba(255,255,255,0.02)}
    .balance .sum{font-size:34px;font-weight:800}
    .balance .lbl{color:var(--muted);margin-top:6px;font-size:13px;cursor:pointer}

    /* Actions */
    .actions{display:flex;gap:10px;margin-top:12px}
    .action{
      flex:1;background:linear-gradient(180deg,#0b2230,#071420);border-radius:12px;padding:12px;display:flex;flex-direction:column;align-items:center;gap:6px;color:#e6eef8;font-weight:600;font-size:13px;cursor:pointer;border:1px solid rgba(255,255,255,0.02)
    }
    .action svg{opacity:0.95}

    /* Assets list */
    .section-head{display:flex;justify-content:space-between;align-items:center;margin-top:18px;color:var(--muted);font-weight:700}
    .assets{margin-top:10px;display:flex;flex-direction:column;gap:10px}
    .asset{
      background:linear-gradient(180deg,#0b1b28,#07121a);border-radius:12px;padding:14px;display:flex;justify-content:space-between;align-items:center;border:1px solid rgba(255,255,255,0.02)
    }
    .asset-left{display:flex;gap:12px;align-items:center}
    .coin-badge{width:52px;height:52;border-radius:10px;background:linear-gradient(135deg,#072634,#0c2d3a);display:flex;align-items:center;justify-content:center;font-weight:800}
    .coin-info{display:flex;flex-direction:column}
    .coin-title{font-weight:700}
    .coin-price{color:var(--muted);font-size:13px;margin-top:6px}
    .asset-right{text-align:right}
    .coin-amount{font-weight:700}
    .coin-value{color:var(--muted);font-size:13px;margin-top:6px}

    .percent-up{color:var(--green);font-weight:700;margin-left:8px;font-size:13px}
    .percent-down{color:var(--danger);font-weight:700;margin-left:8px;font-size:13px}

    /* Bottom nav */
    .bottom{
      position:fixed;left:0;right:0;bottom:0;background:linear-gradient(180deg, transparent,#041420);padding:10px 14px;border-top:1px solid rgba(255,255,255,0.02);display:flex;gap:6px;max-width:420px;margin:0 auto;
    }
    .nav-item{flex:1;text-align:center;color:var(--muted);font-weight:700;padding:8px 6px;border-radius:8px;cursor:pointer}
    .nav-item.active{color:#dbeafe}

    /* Wallet modal (half screen) */
    .wallet-modal{
      position:fixed;left:0;right:0;bottom:0;height:50vh;background:linear-gradient(180deg,#071726,#03111a);border-top-left-radius:14px;border-top-right-radius:14px;padding:18px;box-shadow:0 -20px 50px rgba(0,0,0,0.7);display:none;z-index:50;
    }
    .wallet-modal.show{display:block}
    .handle{width:64px;height:4px;background:#0f2a3d;border-radius:4px;margin:6px auto}
    .wallet-row{display:flex;gap:12px;align-items:center}
    .wallet-title{font-weight:800;font-size:18px}
    .wallet-desc{color:var(--muted);margin-top:6px;margin-bottom:10px}
    .wallet-actions{display:flex;gap:10px;margin-top:8px}
    .btn-primary{flex:1;padding:12px;border-radius:12px;background:linear-gradient(90deg,#0ea5e9,#3b82f6);border:none;color:#04202c;font-weight:800;cursor:pointer}
    .btn-ghost{flex:1;padding:12px;border-radius:12px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted);cursor:pointer}

    /* Currency modal in center */
    .currency-modal{position:fixed;left:16px;right:16px;top:50%;transform:translateY(-50%);background:linear-gradient(180deg,#0b1b27,#07121a);padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,0.02);display:none;z-index:60}
    .currency-modal.show{display:block}
    .currency-item{display:flex;justify-content:space-between;padding:10px;border-radius:8px;cursor:pointer}
    .currency-item:hover{background:rgba(255,255,255,0.01)}
    .small-muted{color:var(--muted);font-size:13px}

    /* Responsive tweaks */
    @media (max-width:420px){
      .wrap{padding:10px 10px 110px}
      .avatar{width:46px;height:46}
      .coin-badge{width:48px;height:48}
    }
  </style>
</head>
<body>
  <div class="wrap" id="app">
    <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
      <div class="close" id="btn-close">Закрыть</div>
      <div class="profile-card">
        <div class="avatar" id="avatar">U</div>
        <div class="profile-name">
          <div class="name" id="user-name">Пользователь</div>
          <div class="sub" id="user-sub">@username</div>
          <div class="sub" id="wallet-short" style="display:none;color:var(--accent);font-size:12px;margin-top:6px"></div>
        </div>
        <div style="margin-left:auto">
          <div class="menu-dot">≡</div>
        </div>
      </div>
    </div>

    <div class="balance" role="button">
      <div class="sum" id="total-balance">$0.00</div>
      <div class="lbl" id="balance-currency">Общий баланс</div>
    </div>

    <div class="actions">
      <div class="action" id="btn-send">
        <!-- paper plane icon -->
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M2 21L23 12 2 3 7 12 2 21z" fill="currentColor"/></svg>
        Отправить
      </div>
      <div class="action" id="btn-receive">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M12 2v20M5 9l7-7 7 7" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
        Получить
      </div>
      <div class="action" id="btn-exchange">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M3 12h18M3 6h18M3 18h18" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg>
        Биржа
      </div>
      <div class="action" id="btn-swap">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M7 10l5-5 5 5M7 14l5 5 5-5" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
        Обмен
      </div>
    </div>

    <div class="section-head" style="margin-top:16px">
      <div>Активы</div>
      <div class="small-muted" id="hide-small">Скрыть мелкие балансы</div>
    </div>

    <div class="assets" id="assets">
      <!-- заполнится JS -->
    </div>
  </div>

  <!-- Wallet modal (half-screen) -->
  <div class="wallet-modal" id="wallet-modal" aria-hidden="true">
    <div class="handle"></div>
    <div class="wallet-row">
      <div style="width:52px;height:52;border-radius:10px;background:linear-gradient(135deg,#0ea5e9,#6366f1);display:flex;align-items:center;justify-content:center;font-weight:800;color:#fff">TON</div>
      <div style="flex:1">
        <div class="wallet-title">Подключить TON кошелёк</div>
        <div class="wallet-desc">Подключите кошелёк TON, чтобы отправлять и получать Toncoin прямо из приложения.</div>
      </div>
    </div>

    <div class="wallet-actions" style="margin-top:12px">
      <button class="btn-primary" id="connect-ton">Подключить</button>
      <button class="btn-ghost" id="skip-ton">Пропустить</button>
    </div>

    <div id="ton-connect-ui" style="margin-top:12px"></div>
    <div style="color:var(--muted);font-size:13px;margin-top:10px">Подключение сохранит адрес в браузере и позволит подписывать транзакции (если вы подключите кошелёк).</div>
  </div>

  <!-- Currency modal -->
  <div class="currency-modal" id="currency-modal" aria-hidden="true">
    <div style="font-weight:800;margin-bottom:8px">Выберите валюту для баланса</div>
    <div class="currency-item" data-cur="USDT"><div>USDT</div><div class="small-muted">Стейбл</div></div>
    <div class="currency-item" data-cur="RUB"><div>RUB</div><div class="small-muted">Российский рубль</div></div>
    <div class="currency-item" data-cur="EUR"><div>EUR</div><div class="small-muted">Евро</div></div>
    <div class="currency-item" data-cur="UAH"><div>UAH</div><div class="small-muted">Гривна</div></div>
    <div class="currency-item" data-cur="TRY"><div>TRY</div><div class="small-muted">Турецкая лира</div></div>
  </div>

  <!-- Bottom nav -->
  <div class="bottom">
    <div class="nav-item active">Главная</div>
    <div class="nav-item">Переводы</div>
    <div class="nav-item">История</div>
    <div class="nav-item">Профиль</div>
  </div>

<script>
(async function(){
  // TELEGRAM WEBAPP
  const tg = window.Telegram?.WebApp;
  if(tg) tg.ready();

  // Elements
  const avatarEl = document.getElementById('avatar');
  const nameEl = document.getElementById('user-name');
  const subEl = document.getElementById('user-sub');
  const walletShortEl = document.getElementById('wallet-short');
  const walletModal = document.getElementById('wallet-modal');
  const connectBtn = document.getElementById('connect-ton');
  const skipBtn = document.getElementById('skip-ton');
  const assetsEl = document.getElementById('assets');
  const totalBalanceEl = document.getElementById('total-balance');
  const balanceCurrencyEl = document.getElementById('balance-currency');
  const currencyModal = document.getElementById('currency-modal');

  // user
  const info = tg?.initDataUnsafe || {};
  const user = info.user || {};
  const displayName = (user.first_name||'') + (user.last_name?(' '+user.last_name):'');
  const username = user.username ? '@'+user.username : '';
  nameEl.textContent = displayName ? displayName : (user.username ? user.username : 'Пользователь');
  subEl.textContent = username ? username : 'mini-приложение';

  // avatar: photo_url if present else initials
  if(user.photo_url){
    avatarEl.style.backgroundImage = `url(${user.photo_url})`;
    avatarEl.textContent = '';
    avatarEl.style.backgroundSize = 'cover';
  } else {
    const initials = ((user.first_name||'U')[0] || 'U') + ((user.last_name||'')[0] || '');
    avatarEl.textContent = initials.toUpperCase();
  }

  // TON CONNECT init (expects tonconnect-ui.min.js available on same domain)
  const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
    manifestUrl: 'https://sending-crypto.vercel.app/tonconnect-manifest.json',
    buttonRootId: 'ton-connect-ui'
  });

  // Coins to show
  const coins = [
    {symbol:'BTC', label:'Bitcoin'},
    {symbol:'ETH', label:'Ethereum'},
    {symbol:'TON', label:'Toncoin'},
    {symbol:'SOL', label:'Solana'},
    {symbol:'LTC', label:'Litecoin'}
  ];

  // Fiat options
  const fiatOptions = ['USDT','RUB','EUR','UAH','TRY'];
  let selectedFiat = localStorage.getItem('selectedFiat') || 'USDT';

  // Helper format
  function fmtNum(n){ if(n === null || n === undefined || isNaN(n)) return '—'; if(n>=1000) return Math.round(n).toLocaleString(); return n.toLocaleString(undefined,{maximumFractionDigits:2}); }
  function fmtCurrency(v, fiat){
    if(isNaN(v)) v = 0;
    if(fiat==='USDT') return '$' + Number(v).toFixed(2);
    if(fiat==='RUB') return Number(v).toFixed(2) + ' ₽';
    if(fiat==='EUR') return Number(v).toFixed(2) + ' €';
    if(fiat==='UAH') return Number(v).toFixed(2) + ' ₴';
    if(fiat==='TRY') return Number(v).toFixed(2) + ' ₺';
    return Number(v).toFixed(2) + ' ' + fiat;
  }

  // TON address saved in localStorage when connected
  let savedTon = localStorage.getItem('tonAddress');
  if(savedTon){
    walletShortEl.style.display='block';
    walletShortEl.textContent = shorten(savedTon);
  } else {
    // Show modal on launch if not connected
    walletModal.classList.add('show');
  }

  // Connect action
  connectBtn.addEventListener('click', async () => {
    try{
      await tonConnectUI.connectWallet(); // opens wallet chooser
    }catch(e){
      console.error('connect error', e);
    }
  });

  // Skip — close modal for this session (but do NOT store skip, so it will reappear on next launch)
  skipBtn.addEventListener('click', () => {
    walletModal.classList.remove('show');
  });

  // When status changes (wallet connects/disconnects)
  tonConnectUI.onStatusChange((wallet) => {
    if(wallet && wallet.account && wallet.account.address){
      const addr = wallet.account.address;
      localStorage.setItem('tonAddress', addr);
      savedTon = addr;
      walletShortEl.style.display='block';
      walletShortEl.textContent = shorten(addr);
      walletModal.classList.remove('show');
      console.log('TON connected', addr);
    } else {
      // could handle disconnect if needed
    }
  });

  // Shorten address
  function shorten(a){ if(!a) return ''; return a.slice(0,6) + '...' + a.slice(-6); }

  // Close button
  document.getElementById('btn-close').addEventListener('click', ()=> {
    if(tg && tg.close) tg.close();
    else window.close();
  });

  // Balance currency selector logic
  balanceCurrencyEl.addEventListener('click', ()=> currencyModal.classList.add('show'));
  currencyModal.querySelectorAll('.currency-item').forEach(it=>{
    it.addEventListener('click', async ()=> {
      const c = it.getAttribute('data-cur');
      selectedFiat = c;
      localStorage.setItem('selectedFiat', c);
      currencyModal.classList.remove('show');
      await loadPrices();
    });
  });

  // close currency modal on outside click
  window.addEventListener('click', (e)=>{
    if(currencyModal.classList.contains('show') && !currencyModal.contains(e.target) && !balanceCurrencyEl.contains(e.target)){
      currencyModal.classList.remove('show');
    }
  });

  // Fetching prices from Binance
  const BINANCE = 'https://api.binance.com/api/v3/ticker/24hr?symbol=';

  async function fetch24(symbol){
    try{
      const r = await fetch(BINANCE + encodeURIComponent(symbol));
      if(!r.ok) return null;
      const j = await r.json();
      return {
        last: parseFloat(j.lastPrice || j.last || j.prevClosePrice || j.lastPrice || 0),
        changePercent: parseFloat(j.priceChangePercent || 0)
      };
    }catch(e){
      return null;
    }
  }

  // conversion rate 1 USDT -> selected fiat
  async function getConv(usdtTo){
    if(usdtTo === 'USDT') return 1;
    // try USDT + FIAT and FIAT+USDT
    const s1 = 'USDT' + usdtTo;
    const s2 = usdtTo + 'USDT';
    let p = await tryFetch(s1);
    if(p !== null) return p;
    p = await tryFetch(s2);
    if(p !== null) return 1 / p;
    return null;
  }
  async function tryFetch(sym){
    try{
      const r = await fetch('https://api.binance.com/api/v3/ticker/price?symbol=' + encodeURIComponent(sym));
      if(!r.ok) return null;
      const j = await r.json();
      return parseFloat(j.price);
    }catch(e){ return null; }
  }

  // Render assets list
  async function loadPrices(){
    assetsEl.innerHTML = '';
    // update total balance label
    balanceCurrencyEl.textContent = `Общий баланс · ${selectedFiat}`;
    // conversion factor
    const conv = await getConv(selectedFiat);

    // fetch all coins (in parallel)
    const promises = coins.map(c => fetch24(c.symbol + 'USDT'));
    const results = await Promise.all(promises);

    coins.forEach((c, idx) => {
      const res = results[idx];
      const last = res ? res.last : null;
      const ch = res ? res.changePercent : null;
      const priceDisplay = last !== null ? ('$' + fmtNum(last)) : '—';
      // convert to selected fiat if possible
      const converted = (last !== null && conv !== null) ? (last * conv) : null;
      const valueDisplay = converted !== null ? fmtCurrency(converted, selectedFiat) : (last !== null ? ('$' + fmtNum(last)) : '—');

      const asset = document.createElement('div');
      asset.className = 'asset';
      asset.innerHTML = `
        <div class="asset-left">
          <div class="coin-badge">${c.symbol}</div>
          <div class="coin-info">
            <div class="coin-title">${c.label}</div>
            <div class="coin-price">${priceDisplay} ${ch!==null ? (ch>=0? '<span class="percent-up">▲ ' + Number(ch).toFixed(2)+'%':'<span class="percent-down">▼ ' + Number(Math.abs(ch)).toFixed(2)+'%')+'</span>':''}</div>
          </div>
        </div>
        <div class="asset-right">
          <div class="coin-amount">0 ${c.symbol}</div>
          <div class="coin-value">${valueDisplay}</div>
        </div>
      `;
      assetsEl.appendChild(asset);
    });

    // total balance — prototype zero
    if(selectedFiat === 'USDT') totalBalanceEl.textContent = '$0.00';
    else totalBalanceEl.textContent = fmtCurrency(0, selectedFiat);
  }

  // initial load
  await loadPrices();
  // refresh every 30s
  setInterval(loadPrices, 30000);

  // clicking asset -> detail placeholder
  assetsEl.addEventListener('click', (e)=>{
    const row = e.target.closest('.asset');
    if(!row) return;
    const coin = row.querySelector('.coin-badge').textContent;
    if(window.Telegram && Telegram.WebApp) {
      Telegram.WebApp.showPopup && Telegram.WebApp.showPopup({message: coin + ' — подробный экран (заглушка)'});
    } else alert(coin + ' — подробный экран (заглушка)');
  });

  // If user already connected TON, show shortened address
  // (we already set it above from savedTon)
  // Allow clicking address to copy
  walletShortEl.addEventListener('click', async ()=>{
    if(!savedTon) return;
    try{
      await navigator.clipboard.writeText(savedTon);
      // show quick feedback
      if(tg && tg.showToast) tg.showToast('Скопировано');
      else alert('Скопировано');
    }catch(e){
      console.error('copy failed', e);
    }
  });

  // small UI interactions no-op
  document.getElementById('btn-send').addEventListener('click', ()=> alert('Отправить — заглушка'));
  document.getElementById('btn-receive').addEventListener('click', ()=> alert('Получить — заглушка'));
  document.getElementById('btn-exchange').addEventListener('click', ()=> alert('Биржа — заглушка'));
  document.getElementById('btn-swap').addEventListener('click', ()=> alert('Обмен — заглушка'));
})();
</script>
</body>
</html>
