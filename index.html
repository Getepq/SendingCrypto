<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>SendingCrypto</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- TonConnect UI (локальный файл на Vercel) -->
  <script src="./tonconnect-ui.min.js"></script>

  <style>
    /* Доп. полировка чтобы пиксельно ближе к скрину */
    body { background: linear-gradient(180deg,#071225 0%, #02111a 100%); -webkit-font-smoothing:antialiased; font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
    /* scrollbar small */
    ::-webkit-scrollbar { height:8px; width:8px }
    ::-webkit-scrollbar-thumb{ background: rgba(255,255,255,0.06); border-radius:8px }
  </style>
</head>
<body class="text-slate-100">

  <div id="app" class="max-w-[420px] mx-auto p-4 pb-24">

    <!-- Top row -->
    <div class="flex items-start gap-3">
      <button id="btn-close" class="text-slate-300 text-sm">Закрыть</button>
      <div class="flex-1 rounded-xl bg-gradient-to-b from-slate-900/70 to-slate-900/50 border border-slate-800 p-3 flex items-center gap-3 shadow-[0_6px_20px_rgba(2,6,12,0.6)]">
        <div id="avatar" class="w-12 h-12 rounded-full bg-slate-800 flex items-center justify-center text-sky-100 font-semibold overflow-hidden">U</div>
        <div class="flex-1">
          <div id="user-name" class="font-semibold text-slate-100">Пользователь</div>
          <div id="user-sub" class="text-slate-400 text-xs mt-1">mini-приложение</div>
          <div id="ton-address" class="text-sky-400 text-[12px] mt-1 hidden cursor-pointer"></div>
        </div>
        <div class="w-10 h-10 rounded-lg bg-slate-800 flex items-center justify-center text-slate-400">≡</div>
      </div>
    </div>

    <!-- Balance card -->
    <div class="mt-4 rounded-2xl bg-gradient-to-b from-slate-900/60 to-slate-900/40 border border-slate-800 p-6 text-center shadow-[0_8px_30px_rgba(2,6,12,0.6)]">
      <div id="total-balance" class="text-4xl font-extrabold">$0.00</div>
      <div id="balance-currency" class="text-slate-400 mt-2">Общий баланс · <span id="selected-fiat">USDT</span></div>
    </div>

    <!-- Actions -->
    <div class="mt-4 grid grid-cols-4 gap-3">
      <div class="rounded-xl bg-slate-800/60 border border-slate-800 p-3 flex flex-col items-center justify-center gap-2 text-xs font-semibold">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" class="text-slate-100"><path d="M2 21L23 12 2 3 7 12 2 21z" fill="currentColor"/></svg>
        <div>Отправить</div>
      </div>
      <div class="rounded-xl bg-slate-800/60 border border-slate-800 p-3 flex flex-col items-center justify-center gap-2 text-xs font-semibold">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" class="text-slate-100"><path d="M12 2v20M5 9l7-7 7 7" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
        <div>Получить</div>
      </div>
      <div class="rounded-xl bg-slate-800/60 border border-slate-800 p-3 flex flex-col items-center justify-center gap-2 text-xs font-semibold">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" class="text-slate-100"><path d="M3 12h18M3 6h18M3 18h18" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg>
        <div>Биржа</div>
      </div>
      <div class="rounded-xl bg-slate-800/60 border border-slate-800 p-3 flex flex-col items-center justify-center gap-2 text-xs font-semibold">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" class="text-slate-100"><path d="M7 10l5-5 5 5M7 14l5 5 5-5" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
        <div>Обмен</div>
      </div>
    </div>

    <!-- Assets header -->
    <div class="mt-5 flex items-center justify-between">
      <div class="text-slate-200 font-semibold">Активы</div>
      <div id="hide-small" class="text-sky-400 text-sm cursor-pointer">Скрыть мелкие балансы</div>
    </div>

    <!-- Assets list -->
    <div id="assets" class="mt-3 space-y-3">
      <!-- JS will inject assets cards here -->
    </div>

  </div>

  <!-- Bottom nav -->
  <div class="fixed bottom-0 left-0 right-0 bg-gradient-to-t from-slate-900/90 to-transparent border-t border-slate-800">
    <div class="max-w-[420px] mx-auto flex justify-between p-2">
      <div class="flex-1 text-center py-2 text-sky-400 font-semibold">Главная</div>
      <div class="flex-1 text-center py-2 text-slate-400 font-semibold">Переводы</div>
      <div class="flex-1 text-center py-2 text-slate-400 font-semibold">История</div>
      <div class="flex-1 text-center py-2 text-slate-400 font-semibold">Профиль</div>
    </div>
  </div>

  <!-- TON wallet modal (half-screen) -->
  <div id="wallet-modal" class="fixed left-0 right-0 bottom-0 h-[52vh] bg-gradient-to-b from-slate-900/95 to-slate-900/80 rounded-t-2xl border-t border-slate-800 p-4 transform translate-y-0 hidden z-50">
    <div class="w-16 h-1.5 bg-slate-800 rounded mx-auto mb-3"></div>
    <div class="flex items-center gap-3">
      <div class="w-12 h-12 rounded-lg bg-gradient-to-br from-sky-500 to-violet-600 flex items-center justify-center font-bold">TON</div>
      <div class="flex-1">
        <div class="font-bold text-lg">Подключить TON кошелёк</div>
        <div class="text-slate-400 text-sm mt-1">Подключите кошелёк TON, чтобы отправлять и получать TON прямо из приложения.</div>
      </div>
    </div>

    <div class="mt-4 flex gap-3">
      <button id="connect-ton" class="flex-1 bg-gradient-to-r from-sky-500 to-indigo-600 text-slate-900 font-bold py-3 rounded-lg">Подключить</button>
      <button id="skip-ton" class="flex-1 border border-slate-700 text-slate-300 py-3 rounded-lg">Пропустить</button>
    </div>

    <div id="ton-connect-ui" class="mt-4"></div>

    <div class="text-slate-400 text-xs mt-4">Подключение позволит взаимодействовать с адресами Ton и подписывать транзакции.</div>
  </div>

  <!-- Currency modal (center) -->
  <div id="currency-modal" class="fixed left-4 right-4 top-1/2 -translate-y-1/2 bg-slate-900/80 border border-slate-800 rounded-lg p-3 hidden z-40">
    <div class="font-semibold mb-2">Выберите валюту</div>
    <div class="space-y-2">
      <div data-cur="USDT" class="p-2 rounded flex justify-between cursor-pointer hover:bg-slate-800/40">USDT <span class="text-slate-400 text-sm">Стейбл</span></div>
      <div data-cur="RUB" class="p-2 rounded flex justify-between cursor-pointer hover:bg-slate-800/40">RUB <span class="text-slate-400 text-sm">Российский рубль</span></div>
      <div data-cur="EUR" class="p-2 rounded flex justify-between cursor-pointer hover:bg-slate-800/40">EUR <span class="text-slate-400 text-sm">Евро</span></div>
      <div data-cur="UAH" class="p-2 rounded flex justify-between cursor-pointer hover:bg-slate-800/40">UAH <span class="text-slate-400 text-sm">Гривна</span></div>
      <div data-cur="TRY" class="p-2 rounded flex justify-between cursor-pointer hover:bg-slate-800/40">TRY <span class="text-slate-400 text-sm">Турецкая лира</span></div>
    </div>
  </div>

<script>
(async function(){
  // Telegram WebApp init
  const tg = window.Telegram?.WebApp;
  if(tg) try{ tg.ready(); }catch(e){}

  // DOM refs
  const avatarEl = document.getElementById('avatar');
  const nameEl = document.getElementById('user-name');
  const subEl = document.getElementById('user-sub');
  const tonAddrEl = document.getElementById('ton-address');
  const totalBalanceEl = document.getElementById('total-balance');
  const balanceCurrencyEl = document.getElementById('balance-currency');
  const selectedFiatEl = document.getElementById('selected-fiat');
  const assetsEl = document.getElementById('assets');
  const walletModal = document.getElementById('wallet-modal');
  const connectBtn = document.getElementById('connect-ton');
  const skipBtn = document.getElementById('skip-ton');
  const currencyModal = document.getElementById('currency-modal');

  // user info from Telegram
  const info = tg?.initDataUnsafe || {};
  const user = info.user || {};
  const fullName = ((user.first_name||'') + (user.last_name?(' '+user.last_name):'')).trim();
  const username = user.username ? '@' + user.username : 'mini-приложение';
  nameEl.textContent = fullName || (user.username || 'Пользователь');
  subEl.textContent = username;

  // avatar
  if(user.photo_url){
    avatarEl.style.backgroundImage = `url(${user.photo_url})`;
    avatarEl.style.backgroundSize = 'cover';
    avatarEl.textContent = '';
  } else {
    const initials = ((user.first_name||'U')[0] || 'U') + ((user.last_name||'')[0] || '');
    avatarEl.textContent = initials.toUpperCase();
  }

  // TonConnect init (expects tonconnect-ui.min.js available)
  const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
    manifestUrl: 'https://sending-crypto.vercel.app/tonconnect-manifest.json',
    buttonRootId: 'ton-connect-ui'
  });

  // coins
  const coins = [
    {symbol:'BTC', label:'Bitcoin'},
    {symbol:'ETH', label:'Ethereum'},
    {symbol:'TON', label:'Toncoin'},
    {symbol:'SOL', label:'Solana'},
    {symbol:'LTC', label:'Litecoin'}
  ];

  // fiat
  let selectedFiat = localStorage.getItem('selectedFiat') || 'USDT';
  selectedFiatEl.textContent = selectedFiat;

  // show wallet modal on startup if no saved TON address
  let savedTon = localStorage.getItem('tonAddress');
  if(!savedTon){
    // open modal
    walletModal.classList.remove('hidden');
  } else {
    tonAddrEl.classList.remove('hidden');
    tonAddrEl.textContent = shorten(savedTon);
  }

  // connect button
  connectBtn.addEventListener('click', async () => {
    try {
      await tonConnectUI.connectWallet();
    } catch(e){
      console.error('TonConnect connect error', e);
    }
  });

  // skip button - close modal and go to main (but do not persist skip)
  skipBtn.addEventListener('click', () => {
    walletModal.classList.add('hidden');
  });

  // when TonConnect status changes (connected)
  tonConnectUI.onStatusChange((wallet) => {
    if(wallet && wallet.account && wallet.account.address){
      const addr = wallet.account.address;
      localStorage.setItem('tonAddress', addr);
      savedTon = addr;
      tonAddrEl.classList.remove('hidden');
      tonAddrEl.textContent = shorten(addr);
      walletModal.classList.add('hidden');
    }
  });

  // copy on click
  tonAddrEl.addEventListener('click', async () => {
    if(!savedTon) return;
    try{
      await navigator.clipboard.writeText(savedTon);
      if(tg && tg.showToast) tg.showToast('Скопировано');
      else alert('Скопировано');
    }catch(e){
      console.error(e);
    }
  });

  // currency modal open on clicking balance
  balanceCurrencyEl.addEventListener('click', () => {
    currencyModal.classList.remove('hidden');
  });

  // currency selection
  currencyModal.querySelectorAll('[data-cur]').forEach(el=>{
    el.addEventListener('click', async () => {
      selectedFiat = el.getAttribute('data-cur');
      localStorage.setItem('selectedFiat', selectedFiat);
      selectedFiatEl.textContent = selectedFiat;
      currencyModal.classList.add('hidden');
      await loadPrices();
    });
  });

  // close currency modal by clicking outside
  window.addEventListener('click', (e) => {
    if(!currencyModal.classList.contains('hidden') && !currencyModal.contains(e.target) && !balanceCurrencyEl.contains(e.target)){
      currencyModal.classList.add('hidden');
    }
  });

  // close app button
  document.getElementById('btn-close').addEventListener('click', () => {
    if(tg && tg.close) tg.close();
    else window.close();
  });

  // formatting helpers
  function fmtNum(n){ if(n==null || isNaN(n)) return '—'; if(n>=1000) return Math.round(n).toLocaleString(); return n.toLocaleString(undefined,{maximumFractionDigits:2}); }
  function fmtCurrency(v, fiat){
    if(isNaN(v)) v=0;
    if(fiat==='USDT') return '$' + Number(v).toFixed(2);
    if(fiat==='RUB') return Number(v).toFixed(2) + ' ₽';
    if(fiat==='EUR') return Number(v).toFixed(2) + ' €';
    if(fiat==='UAH') return Number(v).toFixed(2) + ' ₴';
    if(fiat==='TRY') return Number(v).toFixed(2) + ' ₺';
    return Number(v).toFixed(2) + ' ' + fiat;
  }

  // Binance helpers
  async function fetch24(sym){
    try{
      const res = await fetch('https://api.binance.com/api/v3/ticker/24hr?symbol=' + encodeURIComponent(sym));
      if(!res.ok) return null;
      const j = await res.json();
      return { last: parseFloat(j.lastPrice || j.last || 0), change: parseFloat(j.priceChangePercent || 0) };
    }catch(e){ return null; }
  }

  async function fetchSymbolPrice(sym){
    try{
      const r = await fetch('https://api.binance.com/api/v3/ticker/price?symbol=' + encodeURIComponent(sym));
      if(!r.ok) return null;
      const j = await r.json();
      return parseFloat(j.price);
    }catch(e){ return null; }
  }

  // get conversion: 1 USDT -> selectedFiat
  async function getConv(target){
    if(target === 'USDT') return 1;
    const s1 = 'USDT' + target;
    const s2 = target + 'USDT';
    let p = await fetchSymbolPrice(s1);
    if(p !== null) return p;
    p = await fetchSymbolPrice(s2);
    if(p !== null) return 1 / p;
    return null;
  }

  // render assets like on screenshot
  async function loadPrices(){
    assetsEl.innerHTML = '';
    selectedFiatEl.textContent = selectedFiat;
    const conv = await getConv(selectedFiat);

    // fetch in parallel
    const ps = coins.map(c => fetch24(c.symbol + 'USDT'));
    const results = await Promise.all(ps);

    coins.forEach((c, i) => {
      const res = results[i];
      const last = res ? res.last : null;
      const change = res ? res.change : null;
      const priceStr = last ? ('$' + fmtNum(last)) : '—';
      const changeHtml = (change !== null && !isNaN(change)) ? (change >= 0 ? `<span class="text-emerald-400 font-semibold">▲ ${Math.abs(change).toFixed(2)}%</span>` : `<span class="text-rose-400 font-semibold">▼ ${Math.abs(change).toFixed(2)}%</span>`) : '';
      const converted = (last !== null && conv !== null) ? (last * conv) : null;
      const rightValue = converted !== null ? fmtCurrency(converted, selectedFiat) : (last !== null ? ('$' + fmtNum(last)) : '—');

      const card = document.createElement('div');
      card.className = 'rounded-xl bg-gradient-to-b from-slate-900/60 to-slate-900/40 border border-slate-800 p-4 flex justify-between items-center';
      card.innerHTML = `
        <div class="flex items-center gap-4">
          <div class="w-12 h-12 flex items-center justify-center rounded-lg bg-slate-800/60 font-bold">${c.symbol}</div>
          <div>
            <div class="font-semibold">${c.label}</div>
            <div class="text-sm text-slate-400 mt-1">${priceStr} ${changeHtml}</div>
          </div>
        </div>
        <div class="text-right">
          <div class="font-semibold">0 ${c.symbol}</div>
          <div class="text-sm text-slate-400 mt-1">${rightValue}</div>
        </div>
      `;
      assetsEl.appendChild(card);
    });

    // top balance stays zero for prototype
    totalBalanceEl.textContent = (selectedFiat === 'USDT') ? '$0.00' : fmtCurrency(0, selectedFiat);
  }

  // initial load + refresh
  await loadPrices();
  setInterval(loadPrices, 30000);

  // helper shorten
  function shorten(a){ return a ? (a.slice(0,6) + '...' + a.slice(-6)) : ''; }

})();
</script>

</body>
</html>

