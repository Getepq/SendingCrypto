<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Crypto MiniApp ‚Äî Demo</title>

  <!-- Telegram WebApp (—Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–æ –∏–∑ Telegram) -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root{
      --bg:#0e0f12;
      --panel:#18181b;
      --muted:#a1a1aa;
      --card:#27272a;
      --accent1: #6366f1;
      --accent2: #06b6d4;
      --glass: rgba(255,255,255,0.02);
    }

    *{box-sizing:border-box}
    html,body{height:100%; margin:0; font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial; background:var(--bg); color:#e5e7eb; -webkit-font-smoothing:antialiased}
    .wrap{min-height:100vh; display:flex; align-items:center; justify-content:center; padding:20px}

    /* App panel */
    .app{
      width:360px;
      max-width:calc(100% - 32px);
      background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent), var(--panel);
      border-radius:18px;
      padding:18px;
      box-shadow:0 10px 30px rgba(2,6,23,0.7);
      position:relative;
      overflow:visible;
      animation:panelIn .5s cubic-bezier(.2,.9,.2,1);
    }
    @keyframes panelIn{from{opacity:0; transform:translateY(10px)} to{opacity:1; transform:none}}

    /* settings gear top-right */
    .settings{
      position:absolute; top:12px; right:12px; cursor:pointer; color:#9ca3af; font-size:20px;
      background:transparent; border:none;
    }
    .settings:hover{color:#fff}

    /* dropdown menu with fade+slide */
    .dropdown{
      position:absolute; top:46px; right:10px; width:160px;
      background:var(--card); border-radius:10px; box-shadow:0 8px 30px rgba(0,0,0,0.5);
      overflow:hidden; transform-origin:top right; opacity:0; transform:translateY(-6px) scale(.98);
      transition:opacity .22s ease, transform .22s cubic-bezier(.2,.9,.2,1);
      pointer-events:none;
    }
    .dropdown.show{opacity:1; transform:translateY(0) scale(1); pointer-events:auto}
    .dropdown button{display:block; width:100%; background:transparent; border:none; color:#d1d5db; padding:10px 12px; text-align:left; cursor:pointer}
    .dropdown button:hover{background:#333338}

    /* profile */
    .profile{display:flex; flex-direction:column; align-items:center; gap:8px; padding-top:6px}
    .avatar{width:66px; height:66px; border-radius:50%; background:linear-gradient(135deg,var(--accent1),var(--accent2)); box-shadow:0 8px 24px rgba(99,102,241,0.18); display:flex; align-items:center; justify-content:center; font-weight:700; font-size:22px; overflow:hidden}
    .avatar img{width:100%; height:100%; object-fit:cover; display:block}
    .name{font-weight:600; font-size:15px}
    .balance{font-weight:700; font-size:30px; margin-top:6px}
    .sub{color:var(--muted); font-size:13px; margin-bottom:8px}

    /* currency selector */
    .controls{display:flex; gap:10px; align-items:center; justify-content:center; margin-bottom:10px}
    select.currency{appearance:none; -webkit-appearance:none; padding:7px 10px; background:var(--card); border-radius:8px; border:none; color:#e6e6e6; font-size:13px; cursor:pointer}
    .lang-ind{color:var(--muted); font-size:13px}

    /* buttons row */
    .buttons{display:flex; gap:10px; margin:12px 0 14px}
    .btn{flex:1; background:var(--card); border-radius:12px; padding:10px 8px; border:none; cursor:pointer; color: #eaeaea; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:6px; position:relative; overflow:hidden; transition:transform .18s ease, background .18s ease}
    .btn svg{width:20px; height:20px; opacity:.95}
    .btn span{font-size:13px}
    .btn:hover{transform:translateY(-4px); background:#34343a}
    .btn:active{transform:scale(.98)}

    /* ripple */
    .ripple{position:absolute; border-radius:50%; transform:scale(0); animation:rip .6s linear; background:rgba(255,255,255,0.16)}
    @keyframes rip{to{transform:scale(4); opacity:0}}

    /* footer info card */
    .info-card{background:linear-gradient(90deg, rgba(99,102,241,0.06), rgba(6,182,212,0.03)), var(--card); padding:12px; border-radius:12px; display:flex; align-items:center; gap:12px}
    .info-left{flex:1}
    .info-title{font-size:13px; font-weight:600}
    .info-sub{color:var(--muted); font-size:12px}

    /* markets */
    .markets{margin-top:14px; display:grid; grid-template-columns: 1fr; gap:8px}
    .coin{display:flex; align-items:center; justify-content:space-between; background:rgba(255,255,255,0.02); padding:8px 10px; border-radius:10px}
    .coin-left{display:flex; align-items:center; gap:10px}
    .coin-icon{width:36px; height:36px; border-radius:8px; display:flex; align-items:center; justify-content:center; font-weight:700; font-size:14px; background:linear-gradient(135deg,var(--accent1),var(--accent2)); color:#fff}
    .coin-name{font-size:13px; font-weight:600}
    .coin-sub{color:var(--muted); font-size:12px}
    .coin-right{text-align:right}
    .coin-price{font-weight:700}
    .coin-change{font-size:12px; display:flex; align-items:center; gap:6px; justify-content:flex-end}

    .up{color:#10b981} /* green */
    .down{color:#ef4444} /* red */

    /* small screens adjust */
    @media (max-width:380px){ .app{width:320px} .buttons{gap:8px} }

  </style>
</head>
<body>
  <div class="wrap">
    <div class="app" role="application" aria-label="Crypto MiniApp">
      <button class="settings" id="settingsBtn" title="Settings">‚öôÔ∏è</button>

      <div class="dropdown" id="dropdown">
        <button id="lang-ru">–†—É—Å—Å–∫–∏–π üá∑üá∫</button>
        <button id="lang-en">English üá¨üáß</button>
      </div>

      <div class="profile">
        <div class="avatar" id="avatar">U</div>
        <div class="name" id="username">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        <div class="balance" id="balance">$0</div>
        <div class="sub" id="balanceText">–û–±—â–∏–π –±–∞–ª–∞–Ω—Å –≤ USD</div>
      </div>

      <div class="controls">
        <select class="currency" id="currency">
          <option value="usd">USD ($)</option>
          <option value="rub">RUB (‚ÇΩ)</option>
          <option value="eur">EUR (‚Ç¨)</option>
          <option value="try">TRY (‚Ç∫)</option>
          <option value="uah">UAH (‚Ç¥)</option>
        </select>
        <div class="lang-ind" id="lang-ind">RU</div>
      </div>

      <div class="buttons" aria-hidden="false">
        <button class="btn" data-action="deposit" title="–ü–æ–ø–æ–ª–Ω–∏—Ç—å">
          <!-- plus -->
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
          <span id="btn-deposit">–ü–æ–ø–æ–ª–Ω–∏—Ç—å</span>
        </button>

        <button class="btn" data-action="withdraw" title="–í—ã–≤–µ—Å—Ç–∏">
          <!-- arrow left -->
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"/></svg>
          <span id="btn-withdraw">–í—ã–≤–µ—Å—Ç–∏</span>
        </button>

        <button class="btn" data-action="exchange" title="–û–±–º–µ–Ω">
          <!-- swap -->
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7h11M4 17h11M17 7l4 4-4 4"/></svg>
          <span id="btn-exchange">–û–±–º–µ–Ω</span>
        </button>

        <button class="btn" data-action="market" title="–ë–∏—Ä–∂–∞">
          <!-- chart -->
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3v18h18"/></svg>
          <span id="btn-market">–ë–∏—Ä–∂–∞</span>
        </button>
      </div>

      <div class="info-card" style="margin-top:6px">
        <div class="info-left">
          <div class="info-title" id="qr-title">–û–ø–ª–∞—Ç–∞ –ø–æ QR-–∫–æ–¥—É</div>
          <div class="info-sub" id="qr-sub">–û–ø–ª–∞—á–∏–≤–∞–π—Ç–µ –ø–æ–∫—É–ø–∫–∏ —Å –ø–æ–º–æ—â—å—é –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç—ã</div>
        </div>
        <div style="opacity:.9">‚ûú</div>
      </div>

      <div class="markets" id="markets" aria-live="polite" style="margin-top:12px">
        <!-- coins will be injected here -->
      </div>
    </div>
  </div>

  <script>
    /***********************
     * Configuration
     ***********************/
    // CoinGecko ids for coins we want
    const COINS = [
      { id: 'toncoin', symbol: 'TON' },
      { id: 'bitcoin', symbol: 'BTC' },
      { id: 'ethereum', symbol: 'ETH' },
      { id: 'tether', symbol: 'USDT' },
      { id: 'solana', symbol: 'SOL' }
    ];

    // fiat list supported by UI & CoinGecko v.s. currencies
    const FIATS = ['usd','rub','eur','try','uah'];

    // update interval (ms)
    const UPDATE_INTERVAL = 30000; // 30s

    // store last changes for arrow coloring
    let lastPrices = {};

    // UI refs
    const marketsEl = document.getElementById('markets');
    const currencyEl = document.getElementById('currency');
    const balanceEl = document.getElementById('balance');
    const balanceTextEl = document.getElementById('balanceText');
    const langInd = document.getElementById('lang-ind');

    // language & locale
    let lang = 'ru';
    let locale = 'ru-RU';

    /***********************
     * Telegram user
     ***********************/
    try {
      const tg = window.Telegram?.WebApp;
      if (tg) {
        tg.expand();
        const u = tg.initDataUnsafe?.user;
        const usernameEl = document.getElementById('username');
        const avatarEl = document.getElementById('avatar');

        if (u) {
          usernameEl.textContent = (u.first_name || '') + (u.last_name ? ' ' + u.last_name : '');
          if (u.photo_url) {
            const img = document.createElement('img');
            img.src = u.photo_url;
            img.alt = usernameEl.textContent;
            avatarEl.textContent = '';
            avatarEl.appendChild(img);
          } else {
            avatarEl.textContent = (u.first_name || 'U').slice(0,1).toUpperCase();
          }
        } else {
          usernameEl.textContent = '–ì–æ—Å—Ç—å';
          avatarEl.textContent = 'üë§';
        }
      } else {
        // fallback if not opened from Telegram
        document.getElementById('username').textContent = 'Guest (demo)';
        document.getElementById('avatar').textContent = 'G';
      }
    } catch (e) {
      console.warn('Telegram init failed', e);
    }

    /***********************
     * Helper: format money
     ***********************/
    function formatMoney(value, fiat){
      // choose currency symbol position with Intl
      try {
        const opts = { style: 'currency', currency: fiat.toUpperCase(), maximumFractionDigits: 6 };
        return new Intl.NumberFormat(locale, opts).format(value);
      } catch(e){
        // fallback manual symbol
        const symbols = { usd:'$', rub:'‚ÇΩ', eur:'‚Ç¨', try:'‚Ç∫', uah:'‚Ç¥' };
        return (symbols[fiat] || '') + Number(value).toFixed(6);
      }
    }

    /***********************
     * Render coins list (placeholder while loading)
     ***********************/
    function createCoinRow(coin){
      const row = document.createElement('div');
      row.className = 'coin';
      row.dataset.coin = coin.id;
      row.innerHTML = `
        <div class="coin-left">
          <div class="coin-icon">${coin.symbol}</div>
          <div>
            <div class="coin-name">${coin.symbol}</div>
            <div class="coin-sub">${coin.id}</div>
          </div>
        </div>
        <div class="coin-right">
          <div class="coin-price">‚Ä¶</div>
          <div class="coin-change"><span class="change-val">‚Äî</span></div>
        </div>
      `;
      return row;
    }

    // initial placeholders
    COINS.forEach(c => marketsEl.appendChild(createCoinRow(c)));

    /***********************
     * Fetch from CoinGecko
     * endpoint: /simple/price
     ***********************/
    async function fetchPrices(){
      const vs = FIATS.join(',');
      const ids = COINS.map(c=>c.id).join(',');
      const url = `https://api.coingecko.com/api/v3/simple/price?ids=${encodeURIComponent(ids)}&vs_currencies=${vs}&include_24hr_change=true`;
      try {
        const res = await fetch(url);
        if (!res.ok) throw new Error('network');
        const data = await res.json();
        return data;
      } catch (err) {
        console.error('Price fetch failed', err);
        return null;
      }
    }

    /***********************
     * Update UI with fetched prices
     ***********************/
    async function updateAll(){
      const fiat = currencyEl.value || 'usd';
      const data = await fetchPrices();
      if (!data) {
        // show error small hint
        marketsEl.querySelectorAll('.coin').forEach(row => {
          row.querySelector('.coin-price').textContent = '‚Äî';
          row.querySelector('.change-val').textContent = 'err';
        });
        return;
      }

      COINS.forEach(coin => {
        const row = marketsEl.querySelector(`.coin[data-coin="${coin.id}"]`);
        const priceObj = data[coin.id];
        if (!priceObj) return;
        const rawPrice = priceObj[fiat];
        const change24 = priceObj[fiat + '_24h_change'] ?? 0;

        // update lastPrices to animate comparison
        const last = lastPrices[coin.id]?.price;
        lastPrices[coin.id] = { price: rawPrice, change24 };

        // formatted price
        const formatted = formatMoney(rawPrice, fiat);
        row.querySelector('.coin-price').textContent = formatted;

        // change with arrow
        const changeEl = row.querySelector('.change-val');
        const arrow = change24 >= 0 ? '‚Üë' : '‚Üì';
        changeEl.textContent = `${arrow} ${Math.abs(change24).toFixed(2)}%`;
        changeEl.classList.remove('up','down');
        changeEl.classList.add(change24 >= 0 ? 'up' : 'down');

        // small pulse if changed direction compared to previous value
        if (last !== undefined && last !== rawPrice) {
          // flash background lightly
          row.animate([
            { background: 'rgba(255,255,255,0.00)' },
            { background: (rawPrice > last) ? 'rgba(16,185,129,0.06)' : 'rgba(239,68,68,0.06)' },
            { background: 'rgba(255,255,255,0.00)' }
          ], { duration: 700, easing: 'ease-out' });
        }
      });

      // update balance text to show currency code
      const fiatUpper = fiat.toUpperCase();
      balanceTextEl.textContent = (lang === 'ru') ? `–û–±—â–∏–π –±–∞–ª–∞–Ω—Å –≤ ${fiatUpper}` : `Total balance in ${fiatUpper}`;
      // balance value stays 0 for demo; format symbol
      balanceEl.textContent = formatMoney(0, fiatUpper);
    }

    // initial load
    updateAll();
    // interval
    setInterval(updateAll, UPDATE_INTERVAL);

    /***********************
     * Ripple effect on buttons
     ***********************/
    document.querySelectorAll('.btn').forEach(b=>{
      b.addEventListener('click', e=>{
        const rect = b.getBoundingClientRect();
        const ripple = document.createElement('span');
        ripple.className = 'ripple';
        const size = Math.max(rect.width, rect.height);
        ripple.style.width = ripple.style.height = size + 'px';
        ripple.style.left = (e.clientX - rect.left - size/2) + 'px';
        ripple.style.top = (e.clientY - rect.top - size/2) + 'px';
        b.appendChild(ripple);
        setTimeout(()=> ripple.remove(), 700);

        // here buttons are non-functional (UI demo)
        // but we can show a small temporary effect: flash the info card
        const info = document.querySelector('.info-card');
        info.animate([{ transform: 'translateY(0)' }, { transform: 'translateY(-4px)' }, { transform: 'translateY(0)' }], { duration: 220, easing: 'ease-out' });
      });
    });

    /***********************
     * Settings dropdown animation (fade + slide)
     ***********************/
    const settingsBtn = document.getElementById('settingsBtn');
    const dropdown = document.getElementById('dropdown');
    settingsBtn.addEventListener('click', e=>{
      dropdown.classList.toggle('show');
      // click outside to close
      if (dropdown.classList.contains('show')) {
        setTimeout(()=> {
          const onDoc = (ev) => {
            if (!dropdown.contains(ev.target) && ev.target !== settingsBtn) {
              dropdown.classList.remove('show');
              document.removeEventListener('click', onDoc);
            }
          };
          document.addEventListener('click', onDoc);
        }, 10);
      }
    });

    /***********************
     * Language switch
     ***********************/
    const setLang = (l) => {
      lang = l;
      if (l === 'ru') { locale = 'ru-RU'; langInd.textContent = 'RU';
        document.getElementById('btn-deposit').textContent = '–ü–æ–ø–æ–ª–Ω–∏—Ç—å';
        document.getElementById('btn-withdraw').textContent = '–í—ã–≤–µ—Å—Ç–∏';
        document.getElementById('btn-exchange').textContent = '–û–±–º–µ–Ω';
        document.getElementById('btn-market').textContent = '–ë–∏—Ä–∂–∞';
        document.getElementById('qr-title').textContent = '–û–ø–ª–∞—Ç–∞ –ø–æ QR-–∫–æ–¥—É';
        document.getElementById('qr-sub').textContent = '–û–ø–ª–∞—á–∏–≤–∞–π—Ç–µ –ø–æ–∫—É–ø–∫–∏ —Å –ø–æ–º–æ—â—å—é –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç—ã';
      } else {
        locale = 'en-US'; langInd.textContent = 'EN';
        document.getElementById('btn-deposit').textContent = 'Deposit';
        document.getElementById('btn-withdraw').textContent = 'Withdraw';
        document.getElementById('btn-exchange').textContent = 'Exchange';
        document.getElementById('btn-market').textContent = 'Market';
        document.getElementById('qr-title').textContent = 'Pay via QR';
        document.getElementById('qr-sub').textContent = 'Pay with cryptocurrency';
      }
      // update labels for balance text
      const fiat = currencyEl.value || 'usd';
      balanceTextEl.textContent = (lang === 'ru') ? `–û–±—â–∏–π –±–∞–ª–∞–Ω—Å –≤ ${fiat.toUpperCase()}` : `Total balance in ${fiat.toUpperCase()}`;
      // refresh formatting
      updateAll();
    };

    document.getElementById('lang-ru').addEventListener('click', ()=> { setLang('ru'); dropdown.classList.remove('show'); });
    document.getElementById('lang-en').addEventListener('click', ()=> { setLang('en'); dropdown.classList.remove('show'); });

    /***********************
     * Currency selector change
     ***********************/
    currencyEl.addEventListener('change', ()=> {
      updateAll();
    });

    /***********************
     * Accessibility: close dropdown on ESC
     ***********************/
    document.addEventListener('keydown', e => {
      if (e.key === 'Escape') dropdown.classList.remove('show');
    });

    // initial language
    setLang('ru');

    /***********************
     * Notes for hosting:
     * - CoinGecko allows client-side simple/price calls (rate limits apply).
     * - To avoid CORS or rate-limit issues at scale, proxy via backend.
     ***********************/
  </script>
</body>
</html>
